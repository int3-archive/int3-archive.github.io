---
date: 2025-01-01
title: PE Format บทที่ 1 - PE Format คืออะไร? ทำไมจึงสำคัญ?
category: Portable Executable (PE) format
tags:
- Windows
- Portable Executable (PE) format
description: Portable Executable (PE) format คือ รูปแบบแฟ้ม (file format) มาตรฐานที่ระบบปฏิบัติการ Microsoft Windows ใช้สำหรับจัดเก็บโปรแกรมที่พร้อมสำหรับการประมวลผล
---

# บทที่ 1 - PE Format คืออะไร? ทำไมจึงสำคัญ?

## 1.1 นิยามของ Portable Executable (PE) Format

**Portable Executable (PE) format** คือ รูปแบบแฟ้ม (file format) มาตรฐานที่ระบบปฏิบัติการ Microsoft Windows (ทั้ง 32-bit และ 64-bit) ใช้สำหรับจัดเก็บโปรแกรมที่พร้อมสำหรับการประมวลผล (executables), โค้ดอ็อบเจกต์ (object code) ในบางบริบท, ไลบรารีเชื่อมโยงแบบพลวัต (Dynamic-Link Libraries - DLLs), ไดรเวอร์อุปกรณ์เคอร์เนลโหมด (.SYS files), และไฟล์ไบนารีอื่นๆ ที่เกี่ยวข้องกับการทำงานของโปรแกรมและระบบปฏิบัติการ

คำว่า **"Portable"** ในชื่อ PE format ไม่ได้หมายความว่าไฟล์ PE ที่คอมไพล์สำหรับสถาปัตยกรรมหนึ่ง (เช่น Intel x86) จะสามารถทำงานบนสถาปัตยกรรมอื่น (เช่น ARM64) ได้โดยตรงโดยไม่มีการคอมไพล์ใหม่ แต่หมายถึงความ "portable" ของ **ตัว format เอง** ที่สามารถ:
1.  **รองรับข้อมูลที่จำเป็น** สำหรับการทำงานบนสถาปัตยกรรมต่างๆ ที่ Windows สนับสนุน (เช่น x86, x64, ARM)
2.  **สามารถถูกใช้งานข้ามเวอร์ชันต่างๆ ของ Windows** ได้อย่างสอดคล้องกันในระดับหนึ่ง (backward compatibility)
3.  **มีโครงสร้างที่ยืดหยุ่น** พอที่จะรองรับข้อมูลประเภทต่างๆ ที่จำเป็นสำหรับการโหลดและรันโปรแกรม เช่น โค้ด, ข้อมูล, ทรัพยากร, ข้อมูล relocation, import/export tables เป็นต้น

**สรุปสั้นๆ:** PE format คือ "พิมพ์เขียว" (blueprint) หรือ "โครงสร้าง" (structure) ที่กำหนดอย่างชัดเจนว่าข้อมูลต่างๆ ที่ประกอบกันเป็นโปรแกรมหรือไลบรารี จะถูกจัดเรียง, จัดเก็บ, และตีความอย่างไรโดย Windows loader และส่วนอื่นๆ ของระบบปฏิบัติการ เพื่อให้โปรแกรมสามารถทำงานได้อย่างถูกต้อง

## 1.2 องค์ประกอบหลักที่ใช้ PE Format

PE format ไม่ได้จำกัดอยู่แค่ไฟล์ `.exe` เท่านั้น แต่ยังครอบคลุมไฟล์ประเภทอื่นๆ ที่มีความสำคัญอย่างยิ่งในระบบนิเวศของ Windows ดังนี้:

1.  **Executable files (`.exe`):**
    *   **คำอธิบาย:** โปรแกรมหลักที่ผู้ใช้สามารถเรียกใช้งานได้โดยตรง เพื่อทำงานตามวัตถุประสงค์ที่ออกแบบไว้
    *   **สาเหตุ-เหตุผล:** เป็นหน่วยพื้นฐานของการประมวลผลแอปพลิเคชันใน Windows

2.  **Dynamic-Link Libraries (`.dll`):**
    *   **คำอธิบาย:** ชุดของโค้ดและข้อมูลที่สามารถถูกเรียกใช้งานร่วมกันโดยหลายโปรแกรม ซึ่งช่วยลดขนาดของโปรแกรมหลัก, ส่งเสริมการใช้โค้ดซ้ำ (code reuse), และทำให้การอัปเดตไลบรารีง่ายขึ้นโดยไม่ต้องคอมไพล์โปรแกรมที่เรียกใช้ใหม่ทั้งหมด
    *   **สาเหตุ-เหตุผล:** เพื่อประสิทธิภาพในการใช้ทรัพยากร (หน่วยความจำ, disk space) และความยืดหยุ่นในการพัฒนาและบำรุงรักษาซอฟต์แวร์

3.  **Object code files (`.obj`):**
    *   **คำอธิบาย:** โดยทั่วไป `.obj` ไฟล์ที่ได้จากคอมไพเลอร์ (compiler) มักจะอยู่ในรูปแบบ COFF (Common Object File Format) ซึ่งเป็นส่วนหนึ่งและเป็น "บรรพบุรุษ" ของ PE format ก่อนที่จะถูก linker รวมเข้าเป็น PE file (executable หรือ DLL) อีกที
    *   **สาเหตุ-เหตุผล:** COFF ให้โครงสร้างพื้นฐานสำหรับโค้ดและข้อมูลที่คอมไพล์แล้ว ซึ่ง PE format ขยายต่อยอดมาจาก COFF

4.  **Kernel-mode drivers (`.sys`):**
    *   **คำอธิบาย:** ไฟล์ที่บรรจุโค้ดที่ทำงานในระดับ kernel (ring 0) ของระบบปฏิบัติการ เพื่อควบคุมฮาร์ดแวร์โดยตรงหรือให้บริการระดับต่ำแก่ระบบและแอปพลิเคชัน
    *   **สาเหตุ-เหตุผล:** การทำงานระดับ kernel ต้องการโครงสร้างที่ OS สามารถตรวจสอบและโหลดได้อย่างปลอดภัย PE format ให้โครงสร้างนั้น

5.  **Control Panel applets (`.cpl`):**
    *   **คำอธิบาย:** โปรแกรมขนาดเล็กที่ใช้สำหรับตั้งค่าและปรับแต่งคุณสมบัติต่างๆ ของระบบผ่านทาง Control Panel
    *   **สาเหตุ-เหตุผล:** เป็น DLLs ชนิดพิเศษที่ export ฟังก์ชัน `CPlApplet` เพื่อให้ Control Panel สามารถเรียกใช้งานได้

6.  **Screen savers (`.scr`):**
    *   **คำอธิบาย:** โปรแกรมรักษาหน้าจอ จริงๆ แล้วไฟล์ `.scr` คือไฟล์ `.exe` ที่ถูกเปลี่ยนนามสกุล และต้อง implement command-line arguments เฉพาะ (เช่น `/s` สำหรับแสดงผล, `/p` สำหรับ preview)
    *   **สาเหตุ-เหตุผล:** ใช้ PE format เพื่อให้ OS สามารถรันเป็นโปรแกรมปกติได้

7.  **ActiveX controls (`.ocx`, `.dll`):**
    *   **คำอธิบาย:** คอมโพเนนต์ซอฟต์แวร์ที่สามารถนำมาใช้ซ้ำในแอปพลิเคชันต่างๆ โดยเฉพาะในสภาพแวดล้อม COM (Component Object Model) มักใช้กับเว็บเบราว์เซอร์ (เช่น Internet Explorer ในอดีต) หรือแอปพลิเคชันที่รองรับ OLE (Object Linking and Embedding)
    *   **สาเหตุ-เหตุผล:** เป็น DLLs ที่ implement COM interfaces ทำให้สามารถถูกโหลดและใช้งานโดยแอปพลิเคชันอื่นได้

การที่ไฟล์หลากหลายประเภทเหล่านี้ใช้โครงสร้าง PE format ร่วมกัน ทำให้ Windows มีวิธีการที่เป็นมาตรฐาน (standardized way) ในการจัดการ, โหลด, ตรวจสอบความถูกต้องเบื้องต้น, และประมวลผลไฟล์เหล่านี้

## 1.3 ความสำคัญของ PE Format ในระบบปฏิบัติการ Windows

PE format มีบทบาทสำคัญอย่างยิ่งต่อการทำงานของระบบปฏิบัติการ Windows และแอปพลิเคชันต่างๆ ในหลายแง่มุม:

1.  **การโหลดโปรแกรม (Program Loading):**
    *   **การทำงาน:** Windows Loader (ส่วนหนึ่งของ OS ที่เรียกว่า `ntdll.dll` และ kernel) ใช้ข้อมูลจาก PE header (โดยเฉพาะ Optional Header และ Section Table) เพื่อตัดสินใจว่าจะโหลดไฟล์เข้าสู่ Virtual Address Space (VAS) ของ process อย่างไร, จัดสรรพื้นที่หน่วยความจำที่ใด, แก้ไขตำแหน่งอ้างอิง (relocations) อย่างไรเพื่อให้โค้ดทำงานได้ถูกต้องในตำแหน่งที่โหลด, และจะเริ่มการทำงานของโปรแกรมจากจุดไหน (AddressOfEntryPoint)
    *   **สาเหตุ-เหตุผล:** หากไม่มีโครงสร้างที่ชัดเจน OS จะไม่สามารถโหลดและเตรียมโปรแกรมให้พร้อมทำงานได้อย่างถูกต้องและปลอดภัย

2.  **การจัดการหน่วยความจำ (Memory Management):**
    *   **การทำงาน:** PE format กำหนดคุณลักษณะ (characteristics) ของแต่ละ section (เช่น .text, .data, .rdata) ว่าควรมีสิทธิ์การเข้าถึงหน่วยความจำอย่างไร (เช่น อ่านได้อย่างเดียว - Read-Only, เขียนได้ - Writable, หรือประมวลผลได้ - Executable) Windows Memory Manager ใช้ข้อมูลนี้ในการตั้งค่า Page Table Entries สำหรับหน่วยความจำของ process
    *   **สาเหตุ-เหตุผล:** ช่วยให้ OS สามารถบังคับใช้นโยบายความปลอดภัยของหน่วยความจำ เช่น Data Execution Prevention (DEP) ที่ป้องกันการรันโค้ดจากส่วนของหน่วยความจำที่ควรมีแต่ข้อมูล และ Write Copy (Copy-on-Write) เพื่อการใช้หน่วยความจำร่วมกันอย่างมีประสิทธิภาพ

3.  **การเชื่อมโยงแบบพลวัต (Dynamic Linking):**
    *   **การทำงาน:** PE format สนับสนุนการทำงานของ DLLs ผ่านโครงสร้างข้อมูลสำคัญ เช่น Import Address Table (IAT), Import Directory Table, และ Export Address Table (EAT) ทำให้โปรแกรมสามารถเรียกใช้ฟังก์ชันจากไลบรารีภายนอก (shared libraries) ณ เวลาทำงาน (runtime) ได้
    *   **สาเหตุ-เหตุผล:** ส่งเสริม modularity, code reuse, ลดขนาด executable, และทำให้การอัปเดตไลบรารีง่ายขึ้นโดยไม่ต้องแก้ไขโปรแกรมหลัก

4.  **การจัดการทรัพยากร (Resource Management):**
    *   **การทำงาน:** ไอคอน (icons), สตริง (strings), รูปภาพ (images), เมนู (menus), ข้อมูลเวอร์ชัน (version information), และ manifest ของโปรแกรม ถูกจัดเก็บอย่างเป็นระบบในส่วนของทรัพยากร (resource section, โดยทั่วไปคือ `.rsrc`) ภายใน PE file
    *   **สาเหตุ-เหตุผล:** ทำให้สามารถจัดการและปรับเปลี่ยนทรัพยากรเหล่านี้ได้ (เช่น การทำ localization เป็นภาษาต่างๆ) โดยไม่จำเป็นต้องคอมไพล์โค้ดหลักของโปรแกรมใหม่

5.  **ความเข้ากันได้และความปลอดภัย (Compatibility and Security):**
    *   **การทำงาน:** โครงสร้าง PE ที่เป็นมาตรฐานช่วยให้โปรแกรมที่พัฒนาขึ้นสามารถทำงานได้บน Windows เวอร์ชันต่างๆ (ภายใต้ข้อจำกัดของ API ที่ใช้) และบนสถาปัตยกรรมที่แตกต่างกัน (เช่น x86 และ x64) หากถูกคอมไพล์มาอย่างถูกต้อง นอกจากนี้ โครงสร้าง PE ยังมีฟิลด์สำหรับ Digital Signature เพื่อตรวจสอบความถูกต้องและแหล่งที่มาของไฟล์ (Authenticode)
    *   **สาเหตุ-เหตุผล:** สร้างความน่าเชื่อถือให้ผู้ใช้ และช่วยป้องกันการรันโค้ดที่ถูกดัดแปลงหรือไม่น่าเชื่อถือ

## 1.4 ทำไม Cybersecurity Professionals จึงต้องศึกษา PE Format?

ความรู้ความเข้าใจใน PE format เป็นทักษะพื้นฐานที่จำเป็นอย่างยิ่งสำหรับผู้เชี่ยวชาญด้าน Cybersecurity ในหลากหลายบทบาท เนื่องจากไฟล์ PE เป็นพาหะหลัก (primary vector) ของมัลแวร์และเป็นเป้าหมายของการโจมตีจำนวนมาก:

1.  **นักวิเคราะห์มัลแวร์ (Malware Analysts):**
    *   **Static Analysis:** การตรวจสอบ PE header และส่วนประกอบต่างๆ (เช่น imports, exports, sections, resources, timestamps) โดยไม่ต้องรันมัลแวร์ สามารถเปิดเผยข้อมูลสำคัญมากมาย เช่น:
        *   **Imports (ฟังก์ชัน API ที่เรียกใช้):** บอกถึงความสามารถของมัลแวร์ (เช่น network C&C, file manipulation, process injection)
        *   **Exports (ฟังก์ชันที่ DLL ให้บริการ):** อาจบ่งชี้ว่าเป็น bot, backdoor, หรือมี component อื่นเรียกใช้
        *   **Section names/sizes/permissions:** ชื่อ section ที่ผิดปกติ, ขนาดที่ใหญ่เกินไป, หรือ permission ที่ไม่สมเหตุสมผล (เช่น .text section ที่ writable) อาจเป็นสัญญาณของ packer หรือ obfuscation
        *   **Timestamps (Compile time):** อาจช่วยในการจัดกลุ่มมัลแวร์ หรือระบุช่วงเวลาของ campaign
        *   **Strings:** คำสั่ง, URL, IP address, ชื่อไฟล์, registry keys ที่ซ่อนอยู่
    *   **Identifying Packers/Obfuscators:** มัลแวร์จำนวนมากใช้เทคนิคการบีบอัด (packing) หรือการทำให้สับสน (obfuscation) เพื่อหลบเลี่ยงการตรวจจับของ Antivirus และทำให้การวิเคราะห์ยากขึ้น การเข้าใจโครงสร้าง PE ช่วยให้นักวิเคราะห์สามารถระบุเทคนิคเหล่านี้ (เช่น entry point ที่ผิดปกติ, import table ที่เล็กมาก, section ที่มี entropy สูง) และพยายามทำการ unpack หรือ deobfuscate
    *   **Signature Creation:** ความรู้เกี่ยวกับ PE format (เช่น byte patterns ใน header, ลักษณะเฉพาะของ sections) ช่วยในการสร้าง Signature ที่แม่นยำสำหรับโปรแกรม Antivirus และ Intrusion Detection Systems (IDS) เพื่อตรวจจับมัลแวร์หรือไฟล์ที่น่าสงสัยได้อย่างมีประสิทธิภาพ

2.  **นักทำ Reverse Engineering (Reverse Engineers):**
    *   การทำความเข้าใจว่าโปรแกรมถูกโหลดและทำงานอย่างไรในระดับต่ำ (low-level) เป็นสิ่งจำเป็นในการแกะโค้ด
    *   PE format ให้ "แผนที่" (map) ของโปรแกรม ช่วยในการค้นหาโค้ดส่วนสำคัญ (entry point, function locations), ข้อมูล (global variables, constants), และทำความเข้าใจพฤติกรรมของโปรแกรม ไม่ว่าจะเป็นซอฟต์แวร์ทั่วไป หรือมัลแวร์ที่ซับซ้อน

3.  **ผู้เชี่ยวชาญด้าน Digital Forensics และ Incident Response (DFIR):**
    *   เมื่อเกิดเหตุการณ์ความมั่นคงปลอดภัย (security incident) การวิเคราะห์ไฟล์ executable ที่น่าสงสัยที่พบบนระบบที่ถูกบุกรุก (compromised system) เป็นขั้นตอนสำคัญในการสืบสวน
    *   PE format ช่วยในการระบุว่าไฟล์นั้นๆ ถูกดัดแปลงหรือไม่ (tampering), มีส่วนประกอบที่ผิดปกติหรือน่าสงสัยหรือไม่ (เช่น PE header ที่ไม่ถูกต้อง, section ที่ถูกเพิ่มเข้ามาอย่างผิดกฎ), และอาจให้เบาะแสเกี่ยวกับแหล่งที่มา, เวลาที่ถูกสร้าง/แก้ไข, หรือวัตถุประสงค์ของไฟล์

4.  **นักวิจัยช่องโหว่และนักพัฒนา Exploit (Vulnerability Researchers & Exploit Developers):**
    *   การเข้าใจว่าโค้ดและข้อมูลถูกจัดวางในหน่วยความจำอย่างไร (ตามที่ PE format กำหนด และ OS loader จัดการ) เป็นสิ่งสำคัญในการพัฒนา exploit สำหรับช่องโหว่ต่างๆ เช่น buffer overflows, use-after-free, หรือการสร้าง ROP (Return-Oriented Programming) chains
    *   การทราบตำแหน่งของโครงสร้างข้อมูลสำคัญภายใน PE file (เช่น IAT, EAT, Global Offset Table - GOT ในบางบริบท) หรือการควบคุมข้อมูลใน PE header/sections สามารถช่วยในการ bypass กลไกป้องกันต่างๆ เช่น ASLR (Address Space Layout Randomization) หรือ DEP (Data Execution Prevention)

5.  **นักพัฒนาเครื่องมือความปลอดภัย (Security Tool Developers):**
    *   การสร้างเครื่องมือวิเคราะห์ PE (PE parsers/viewers), disassemblers, debuggers, sandboxes, หรือเครื่องมือ HIPS (Host-based Intrusion Prevention Systems) จำเป็นต้องมีความเข้าใจอย่างลึกซึ้งในโครงสร้าง PE format เพื่อให้สามารถดึงข้อมูล, ตีความ, หรือแม้แต่แก้ไข PE files ได้อย่างถูกต้อง

**สาเหตุ-เหตุผล เชิง Cybersecurity:**
*   **สาเหตุ:** เนื่องจากไฟล์ PE เป็น "พาหนะ" หลักที่มัลแวร์ใช้ในการแพร่กระจายและโจมตีระบบ Windows
*   **เหตุผล:** ดังนั้น การมีความรู้ความเข้าใจใน "กายวิภาค" (anatomy) ของไฟล์ PE จึงเป็นสิ่งจำเป็นสำหรับผู้เชี่ยวชาญด้าน Cybersecurity เพื่อที่จะสามารถ "ผ่าตัด" (dissect), "วินิจฉัย" (diagnose), และ "รักษา" (remediate) ภัยคุกคามที่เกี่ยวข้องกับไฟล์เหล่านี้ได้อย่างมีประสิทธิภาพ

## 1.5 สรุป

PE format ไม่ได้เป็นเพียงแค่รายละเอียดทางเทคนิคสำหรับโปรแกรมเมอร์ระบบ แต่เป็นรากฐานสำคัญที่ค้ำจุนการทำงานของแอปพลิเคชันและระบบปฏิบัติการ Windows ทั้งหมด การเรียนรู้โครงสร้างและรายละเอียดของมัน เปิดประตูสู่ความเข้าใจที่ลึกซึ้งยิ่งขึ้นเกี่ยวกับวิธีการทำงานของซอฟต์แวร์ และที่สำคัญกว่านั้นสำหรับนักศึกษา Cybersecurity คือการมอบเครื่องมือและความรู้ในการวิเคราะห์, ตรวจจับ, และต่อสู้กับภัยคุกคามทางไซเบอร์ที่ใช้ประโยชน์จากหรือซ่อนตัวอยู่ในไฟล์ PE

ในบทต่อไป เราจะย้อนกลับไปดูประวัติความเป็นมาและวิวัฒนาการของ PE format เพื่อให้เข้าใจบริบทและเหตุผลเบื้องหลังการออกแบบของมันได้ดียิ่งขึ้น ซึ่งจะช่วยให้เห็นภาพรวมว่าทำไม PE format จึงมีโครงสร้างอย่างที่เป็นอยู่ในปัจจุบัน
